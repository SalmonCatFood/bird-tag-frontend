# 常见问题解决

## 登录后跳转到 CloudFront 默认页面

### 问题描述

Google OAuth 登录成功后，页面显示：
```
Successfully signed in
This is the default redirect page for Amazon Cognito user pools. 
You're seeing this page because your Amazon Cognito app client doesn't have a return URL set.
```

并且 URL 是 `https://xxxxxxxxx.cloudfront.net`

### 原因

Cognito App Client 的回调 URL 没有正确配置，导致 Cognito 使用默认的 CloudFront 页面。

### 解决方案

#### 步骤 1：配置 Cognito 回调 URL

1. 登录 [AWS Cognito 控制台](https://console.aws.amazon.com/cognito/)
2. 选择您的用户池
3. 点击左侧菜单的 **"应用集成"**（App integration）
4. 在 **"应用客户端"**（App clients）部分，找到并点击您的应用客户端
5. 点击右上角的 **"编辑"**（Edit）按钮
6. 滚动到 **"托管 UI 设置"**（Hosted UI settings）

在 **"允许的回调 URL"**（Allowed callback URLs）中添加：
```
http://localhost:5173/auth/callback
```

**重要提示**：
- URL 必须完全匹配（包括协议、域名、端口和路径）
- 如果是生产环境，使用：`https://your-domain.com/auth/callback`
- 可以添加多个 URL（每行一个）

7. 在 **"允许的 OAuth 流"** 中确保勾选：**Authorization code grant**
8. 在 **"允许的 OAuth 作用域"** 中确保勾选：**email**, **profile**, **openid**
9. 点击 **"保存更改"**

#### 步骤 2：验证 .env 配置

确保您的 `.env` 文件中配置了正确的回调 URL：

```env
VITE_COGNITO_REDIRECT_SIGN_IN=http://localhost:5173/auth/callback
```

**注意**：`.env` 中的 URL 必须与 Cognito 控制台中配置的 URL 完全一致。

#### 步骤 3：重新测试

1. 清除浏览器缓存和 localStorage
2. 刷新页面
3. 重新点击 "使用 Google 登录"

现在应该可以正确跳转回您的应用了。

---

## OAuth 回调 URL 不匹配错误

### 问题描述

登录时出现错误：
```
redirect_uri_mismatch
```

### 原因

`.env` 文件中配置的回调 URL 与 Cognito 控制台中配置的回调 URL 不一致。

### 解决方案

1. 检查 `.env` 文件中的 `VITE_COGNITO_REDIRECT_SIGN_IN`
2. 登录 Cognito 控制台，查看 App Client 的 "允许的回调 URL"
3. 确保两者完全一致（包括协议、域名、端口、路径）
4. 如果修改了 `.env` 文件，需要重启开发服务器

---

## 域名重复错误

### 问题描述

跳转时 URL 变成：
```
https://your-domain.auth.ap-southeast-2.amazoncognito.com.auth.ap-southeast-2.amazoncognito.com
```

### 原因

`VITE_COGNITO_DOMAIN` 配置了完整域名，但代码又拼接了域名后缀。

### 解决方案

`VITE_COGNITO_DOMAIN` 支持两种格式：

**方式 1：只配置域名前缀（推荐）**
```env
VITE_COGNITO_DOMAIN=your-domain
```

**方式 2：配置完整域名（也支持）**
```env
VITE_COGNITO_DOMAIN=your-domain.auth.ap-southeast-2.amazoncognito.com
```

代码会自动检测并处理这两种格式。

---

## CORS 错误

### 问题描述

浏览器控制台显示 CORS 错误。

### 解决方案

确保后端 API Gateway 已配置 CORS：
- 允许的源：`http://localhost:5173` 或您的域名
- 允许的方法：GET, POST, PUT, DELETE, OPTIONS
- 允许的头：Authorization, Content-Type

---

## Token 过期

### 问题描述

已登录但仍然跳转到登录页。

### 解决方案

1. 检查浏览器控制台是否有错误
2. 清除 localStorage 中的 token
3. 重新登录

或者在浏览器控制台执行：
```javascript
localStorage.clear()
```

然后刷新页面重新登录。

---

## WebSocket 连接失败

### 问题描述

文件上传后无法收到实时更新。

### 解决方案

1. 检查 WebSocket URL 配置：
   ```env
   VITE_WEBSOCKET_API_URL=wss://your-websocket-api-id.execute-api.region.amazonaws.com/stage
   ```

2. 确保 WebSocket API Gateway 已正确配置
3. 检查浏览器控制台的 WebSocket 错误信息

---

## 需要更多帮助？

如果以上方案无法解决您的问题，请：
1. 检查浏览器控制台的完整错误信息
2. 查看 Network 标签中的请求详情
3. 确认所有环境变量配置正确

